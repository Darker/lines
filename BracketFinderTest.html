<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        .highlight {
            position: absolute;
            background-color: #4cff00;
            margin: 0px;
            padding: 0px;
            z-index: 0;
        }
        pre {
            position: relative;
            z-index: 10;
        }

    </style>
</head>
<body>
<pre>
/**
 * @typedef {Object} StateData
 * @prop {RegExp} accept
 * @prop {number} charlimit
 * @prop {string} name
 * @prop {StateData} __parent
 * @prop {boolean} totalEnd
 * */


/**
 * @typedef {{[name: string]: StateData}} StateObj
 * @prop {RegExp} accept
 * @prop {number} charlimit
 * @prop {string} name
 * @prop {StateData} __parent
 * @prop {boolean} totalEnd
 * */

const BRACKETS = {
    "{": "}",
    "(": ")",
    "[": "]"
};

/** @type {StateObj} **/
const STATE = {
    name: "none",
    "/": {
        "/": {
            name: "COMMENT",
            accept: /[^\n]/,
            totalEnd: true
        },
        "*": {
            name: "COMMENT",
            "*": {
                "/": {
                    totalEnd: true,
                    accept: /[^\w\W]/
                },
                charlimit: 1
            }
        },
        charlimit: 1
    },
    "\"": {
        name: "STRING",
        accept: /[^"\n]/,
        "\\": {
            accept: /[^\n]/,
            charlimit: 1
        }
    },
    "'": {
        name: "STRING",
        accept: /[^'\n]/,
        "\\": {
            accept: /[^\n]/,
            charlimit: 1
        }
    }
}
/**
 * 
 * @param {Object} object
 */
function makeParents(object) {
    if (typeof object.name != "string") {
        if (object.__parent) {
            Object.defineProperty(object, "name", {
                get: function () { return this.__parent.name; }
            });
        }
        else {
            object.name = "";
        }
    }
    for (let name in object) {
        if (name != "__parent" && object.hasOwnProperty(name)) {
            if (typeof object[name] == "object") {
                object[name].__parent = object;
                makeParents(object[name]);
            }
        }
    }
}
makeParents(STATE);

/**
 * 
 * @param {string} string
 * @param {number} startPosition
 */
function findNextBracket(string, startPosition) {
    const searchedBracket = BRACKETS[string[startPosition]];
    if (searchedBracket == null) {
        throw new Error("Bad bracket position.");
    }
    /** @type {StateData|StateObj} **/
    let state = STATE;
    //used for states with char limit
    let charcount = 0;
    for (let i = 0, l = string.length; i < l; ++i) {
        const character = string[i];
        if (state[character]) {
            state = state[character];
            console.log("[" + i + "] Enter state " + state.name + " through character " + character, state);
            charcount = 0;
        }
        else if (charcount > state.charlimit) {
            const oldstate = state;
            state = endState(state);
            console.log("[" + i + "] Exit state (charcount) " + oldstate.name + " to state " + state.name, state);
        }
        else if (state.accept && !state.accept.test(character)) {
            const oldstate = state;
            state = endState(state);
            console.log("[" + i + "] Exit state (match) " + oldstate.name + " to state " + state.name, state);
        }
        if (state.name != "COMMENT" && state.name != "STRING") {
            if (character == searchedBracket) {
                return i;
            }
        }
        charcount++;
    }
    throw new Error("Unmatched bracket: " + searchedBracket);
}

/**
 * 
 * @param {StateData} state
 * @returns {StateData|StateObj}
 */
function endState(state) {
    return state.totalEnd ? STATE : state.__parent;
}

export default findNextBracket;
</pre>
<script type="module" src="./BracketFinderTest.js"></script>
</body>
</html>